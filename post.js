const posts = [
    {
        title: "Weight of Two Crimes I Only Dreamed",
        date: "11/21/2025 7:16pm",
        content: [
            { type: "text", value: "1st dream i had a dream where i stabbed someone in my school i vividly remember where but don't remember who i stabbed it was in my school it was like a hang out area for those in my school from the entrance go to the canteen, then forward to the lifts, go right and then left, go to the red block and go up by one floor the dream was i overheard between two people that in retrospect don't exist anywhere in my school nor country i for some reason overheard they were going to fight in that location after school and for some reason i went and waited there once it was time i remember sitting down and looking at the staircase and suddenly some short guy came up and shouted out HEY, WHOS FIGHTING ME? while looking left and right rapidly and on at the right side of my eye some tall guy came over like stomping and for some reason i stood up and had a knife and stabbed him around the stomach and then i suddenly felt huge pain in my stomach it was sudden and didn't carry long after waking up and i think, really think because i dont know exactly whether he actually had a knife or it was that tall guy or someone else but this whole discourse happened at the mouth of the staircase opening, then after stabbing him i felt this wave of sympathy for him and sadness for me because suddenly all of the blue his life and my life could end here, everything that we have done worked for had all came to an end because of this so i suddenly said im sorry im sorry lets go to the hospital and walked downwards the staircase while carrying each other, i think that's where the dream ended.", size: "1em" },
            { type: "text", value: "2nd dream i had a dream where i was the one of the founders of a drug cartel i think i got this dream because i watched Alternate Breaking Bad Ending Malcolm in the Middle Edition i dont know what happened in the start to middle of the thing but I remember suddenly having this wave of fear because I would be outed one day and my life would come to a stop whether by a death or a cage till death so i tried to bargin with someone i dont remember who becuase i was the founder and there was another co founder but i bargined with them to say i did not do that much damage or provided for the cartel i just profited off it and the dream ended there", size: "1em" },
        ]
    },
    {
        title: "",
        date: "11/21/2025 9:52pm",
        content: [
            { 
                type: "image", 
                value: "https://raw.githubusercontent.com/eiolincoln/maryintherealworld/main/images/eerilyrealisticfunnymoments.png", 
                width: "40%" 
            },
        ]
    },
    {
        title: "THIS IS A SIGN",
        date: "11/25/2025 9:11pm",
        content: [
            { 
                type: "image", 
                value: "https://raw.githubusercontent.com/eiolincoln/maryintherealworld/main/images/EllaPapo666.png", 
                width: "20%" 
            },
            { 
                type: "image", 
                value: "https://raw.githubusercontent.com/eiolincoln/maryintherealworld/main/images/Angel666NumberNoBackground.png", 
                width: "40%" 
            },
            { type: "text", value: "A SIGN", size: "1em" },
        ]
    },
    {
        title: "good channel",
        date: "11/24/2025 1:57am",
        content: [
            { 
                type: "image", 
                value: "https://raw.githubusercontent.com/eiolincoln/maryintherealworld/main/images/Melitta.png", 
                width: "40%" 
            },
            { type: "text", value: "titles may feel pretentious but the videos are good", size: "1em" },
        ]
    },
    {
        title: "ideal artist for the happiness of society",
        date: "11/24/2025 1:57am",
        content: [
            { type: "text", value: "", size: "1em" }
        ]
    },
    {
        title: "",
        date: "11/23/2025 11:07pm",
        content: [
            { type: "text", value: "edited a video today", size: "1em" }
        ]
    },
    {
        title: "<u>This House Has People in It</u>",
        date: "11/22/2025 12:18am",
        content: [
            { 
                type: "image", 
                value: "https://raw.githubusercontent.com/eiolincoln/maryintherealworld/main/images/niche1.png", 
                width: "25%" 
            },
            { 
                type: "image", 
                value: "https://raw.githubusercontent.com/eiolincoln/maryintherealworld/main/images/niche2.png", 
                width: "30%" 
            }
        ]
    },
    {
        title: "",
        date: "11/21/2025 11:39pm",
        content: [
            { type: "text", value: "this album sucks. i’m preparing for war.", size: "1em" }
        ]
    },
    {
        title: "<u><b>got that water in my еye eye еye</b></u>",
        date: "11/21/2025 10:43pm",
        content: [
            { type: "image", value:"images/Beauty.png", width: "10%" },
            { type: "text", value: "not mine, looks like my grandfathers, but his is green", size: "1em" },
        ]
    },
    {
        title: "21 Photos",
        date: "11/21/2025 8:21pm",
        content: [
            { type: "image", value:"images/Screenshot1.png", width: "25%" },
        ]
    },
    {
        title: "20 Photos",
        date: "11/21/2025 7:16pm",
        content: [
            { type: "text", value: "<i>77</i>", size: "1em" }
        ]
    },
    {
        title: "video test on website",
        date:"11/21/2025 3:19pm",
        content:[
            { type: "video", value: "videos/sparkleinjamen.mp4", width: "50%" },
            { type: "text", value: "11/21/2025 3:19pm anonymous", size: "1em" },
        ]
    },
    {
        title: "hoooly poop Ninajirachi just won ARIAs Best Solo Artist",
        date: "20/11/2025 11:14pm",
        content: [
            { type: "text", value: "this is super f (my computer, cuz no 1 in the World knows me Better) late but", size: "1em" },
            { type: "image", value:"images/AriaAwards2025-LiveShow-VasiliPapathanasopoulos-Ninajirachi-3-6-scaled.jpg", width: "50%" },
            { type: "text", value: "she sniped the mother bullet into john f cuntedys head", size: "1em" },
            { type: "image", value:"images/DiscordNinajirachiQueen.png", width: "25%" },
            { type: "text", value: "gosh i wish listened to her music way earlier i had added f☆ck my computer in my playlist on 11th June 2025 i should've listened earlier maybe<br>could've got her on my Spotify Wrapped but it's too late<br><br>4562 4562 4562 4562 ", size: "1em" },
        ]
    },
    {
        title: "",
        date: "20/11/2025 9:14pm",
        content: [
            { type: "text", value: "eating time", size: "5em" },
            { type: "text", value: "update: this was about dinner", size: "1em" }
        ]
    },
    {
        title: "inventions and ideas",
        date: "20/11/2025 7:24pm",
        content: [
            { type: "text", value: "New bread i think it would be a good idea like most people eat bread in the mornings and i people might not like it after 5000000000000 Times of eating the same bread so imagine if there were new Bread", size: "1.1em" }
        ]
    },
    {
        title: "first post evarrrrrrrrrrrr",
        date: "20/11/2025 5:39pm",
        content: [
            { type: "text", value: "Been listening to I Love My Computer by Ninajirachi.<br>Favourite: Delete", size: "1em" },
            { type: "image", value: "images/ILoveMyComputer.jpg", width: "50%" },
            { type: "text", value: "i like this album i like how all the songs converge together like i think every song works as a interlude to the next CSIRAC to delete<br>is great cat paws up to All I Am is epic i havent gone into the second half of the album that much (aka after All I Am) except for maybe<br>like It's You nice song great album hypoppy", size: "1em" },
            { type: "audio", value: "audio/Delete - Ninajirachi.mp3" }
        ]
    }
];


// --------------------------
// PAGINATION CONFIG
// --------------------------
const postsPerPage = 10;
let currentPage = 1;
const totalPages = Math.ceil(posts.length / postsPerPage);

// --------------------------
// UNIQUE STICK ID HELPER
// --------------------------
let stickIdCounter = 0;
function nextStickId() { return "stick-" + (stickIdCounter++); }

// --------------------------
// GLOBAL STICKY STATE
// --------------------------
let stickyMap = new Map();        // stickId -> { wrapper, clone, frozenWidth, frozenHeight }
let stickyScrollHandler = null;
let cloneStackCounter = 0;

// --------------------------
// RENDER POSTS
// --------------------------
function renderPosts() {
    const container = document.getElementById("posts-container");
    const stack = document.getElementById("sticky-stack");
    if (!container || !stack) return;

    // clear
    container.innerHTML = "";
    stack.innerHTML = "";
    stickyMap.clear();
    cloneStackCounter = 0;

    // remove previous listeners (if any)
    if (stickyScrollHandler) {
        window.removeEventListener('scroll', stickyScrollHandler);
        window.removeEventListener('resize', stickyScrollHandler);
        stickyScrollHandler = null;
    }

    const start = (currentPage - 1) * postsPerPage;
    const pagePosts = posts.slice(start, start + postsPerPage);

    pagePosts.forEach(post => {
        const wrap = document.createElement("div");
        wrap.className = "post-container";

        // Title (force display:block so date sits below)
        const title = document.createElement("h2");
        title.innerHTML = post.title || "";
        title.className = "stickable stick-title";
        title.dataset.stickId = nextStickId();
        title.dataset.stickType = "title";
        title.style.display = "block";       // ensure it's a block so date appears under it
        wrap.appendChild(title);

        // Date (below title)
        if (post.date) {
            const date = document.createElement("p");
            date.className = "datetime stickable stick-date";
            date.textContent = post.date;
            date.dataset.stickId = nextStickId();
            date.dataset.stickType = "date";
            date.style.display = "block";   // ensure block
            wrap.appendChild(date);
        }

        const contentWrap = document.createElement("div");
        contentWrap.className = "post-content";

        post.content.forEach(block => {
            let el;
            const stickId = nextStickId();

            if (block.type === "text") {
                el = document.createElement("p");
                el.innerHTML = block.value;
                el.style.fontSize = block.size || "1em";
                el.className = "stickable stick-text";
                el.dataset.stickId = stickId;
                el.dataset.stickType = "text";
                // text should be inline so highlight hugs text — but for layout we keep it block internally
                el.style.display = "inline-block";
            }

            if (block.type === "image") {
                el = document.createElement("img");
                el.src = block.value;
                if (block.width) el.style.width = block.width;
                el.className = "stickable stick-image post-image";
                el.dataset.stickId = stickId;
                el.dataset.stickType = "image";
                // make sure object-fit doesn't change aspect when cloned
                el.style.display = "block";
                el.style.maxWidth = "100%";
                el.style.height = "auto";
                el.style.background = "transparent";
            }

            if (block.type === "video") {
                el = document.createElement("video");
                el.src = block.value;
                el.controls = true;
                el.loop = true;
                el.autoplay = true;
                el.muted = true;
                el.playsInline = true;
                if (block.width) el.style.width = block.width;
                el.className = "stickable stick-video post-video";
                el.dataset.stickId = stickId;
                el.dataset.stickType = "video";
                el.style.display = "block";
                el.style.maxWidth = "100%";
                el.style.height = "auto";
                el.style.background = "transparent";
            }

            if (block.type === "audio") {
                const audioWrap = document.createElement("div");
                audioWrap.className = "stickable stick-audio audio-container";
                audioWrap.dataset.stickId = stickId;
                audioWrap.dataset.stickType = "audio";

                const audio = document.createElement("audio");
                audio.src = block.value;
                audio.controls = true;
                audio.style.width = "100%";

                audioWrap.appendChild(audio);
                el = audioWrap;
            }

            if (el) contentWrap.appendChild(el);
        });

        wrap.appendChild(contentWrap);
        container.appendChild(wrap);
    });

    renderPagination();
    initStickyEngine();
}

// --------------------------
// RENDER PAGINATION
// --------------------------
function renderPagination() {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = i;
        a.className = i === currentPage ? "current" : "";
        a.onclick = e => {
            e.preventDefault();
            currentPage = i;
            window.scrollTo(0, 0);
            renderPosts();
        };
        pagination.appendChild(a);
    }
}

// --------------------------
// STICKY ENGINE
// - create clone when element's top <= 0
// - remove clone when element's top > 0
// - freeze original element size while cloned to avoid layout jumps
// --------------------------
function initStickyEngine() {
    const stack = document.getElementById("sticky-stack");
    const stickables = Array.from(document.querySelectorAll(".stickable"));

    stickyScrollHandler = function() {
        const vpTop = 0;

        stickables.forEach(el => {
            const stickId = el.dataset.stickId;
            if (!stickId) return;

            const rect = el.getBoundingClientRect();
            const entry = stickyMap.get(stickId);

            // should be stuck when its top is at or above viewport top
            if (rect.top <= vpTop) {
                if (!entry) {
                    // freeze original's computed size to prevent it collapsing/scaling
                    const freezeRect = el.getBoundingClientRect();
                    el.style.minWidth = freezeRect.width + "px";
                    el.style.minHeight = freezeRect.height + "px";
                    el.style.boxSizing = "border-box";

                    const wrapper = createCloneBehind(el);
                    // hide original AFTER we froze its size
                    el.style.visibility = "hidden";

                    stickyMap.set(stickId, { wrapper, frozenWidth: freezeRect.width, frozenHeight: freezeRect.height });
                    stack.appendChild(wrapper);
                } else {
                    // update wrapper left to follow layout shifts
                    const left = el.getBoundingClientRect().left;
                    entry.wrapper.style.left = Math.round(left) + "px";
                }
            } else {
                // unstick
                if (entry) {
                    entry.wrapper.remove();
                    stickyMap.delete(stickId);
                    // restore original
                    el.style.visibility = "visible";
                    el.style.minWidth = "";
                    el.style.minHeight = "";
                    el.style.boxSizing = "";
                }
            }
        });
    };

    // run once immediately to create any stickies already past top
    stickyScrollHandler();

    window.addEventListener('scroll', stickyScrollHandler, { passive: true });
    window.addEventListener('resize', stickyScrollHandler);
}

// --------------------------
// CREATE CLONE BEHIND (pixel-accurate)
// - clone is sized in pixels to match original exactly
// - for images/videos we copy pixel width/height and preserve aspect using objectFit
// - for videos we force muted/paused/non-interactive clone
// --------------------------
function createCloneBehind(el) {
    const wrapper = document.createElement("div");
    wrapper.className = "stacked-item";

    const rect = el.getBoundingClientRect();
    const computed = getComputedStyle(el);

    let clone;

    if (el.tagName === "IMG") {
        clone = document.createElement("img");
        clone.src = el.src;
        clone.style.width = Math.round(rect.width) + "px";
        clone.style.height = Math.round(rect.height) + "px";
        clone.style.display = "block";
        clone.style.objectFit = "contain";
        clone.style.background = "transparent";
    } else if (el.tagName === "VIDEO") {
        clone = document.createElement("video");
        clone.src = el.currentSrc || el.src;
        clone.muted = true;
        clone.volume = 0;
        clone.pause();
        clone.removeAttribute("controls");
        clone.setAttribute("playsinline", "");
        clone.style.pointerEvents = "none";

        clone.style.width = Math.round(rect.width) + "px";
        clone.style.height = Math.round(rect.height) + "px";
        clone.style.display = "block";
        clone.style.objectFit = "contain";
        clone.style.background = "transparent";
    } else {
        clone = el.cloneNode(true);

        // Copy text styling
        clone.style.fontSize = computed.fontSize;
        clone.style.fontFamily = computed.fontFamily;
        clone.style.fontWeight = computed.fontWeight;
        clone.style.lineHeight = computed.lineHeight;
        clone.style.whiteSpace = "pre-wrap";  // allow wrapping if needed
        clone.style.wordBreak = "break-word"; // prevent overflow cutoffs

        const isInline = ["inline", "inline-block"].includes(computed.display);

        if (isInline) {
            clone.style.display = "inline";           // hug text naturally
            clone.style.minWidth = Math.round(rect.width) + "px"; // prevent collapsing
        } else {
            clone.style.display = "block";
            clone.style.width = "fit-content";        // hug content
        }

        clone.style.height = Math.round(rect.height) + "px";
    }

    clone.style.pointerEvents = "none";
    clone.style.margin = "0";
    clone.style.opacity = "1";

    if (["text", "title", "date"].includes(el.dataset.stickType)) {
        clone.classList.add("cloned-text");
    } else {
        clone.classList.add("cloned-media");
    }

    wrapper.appendChild(clone);

    wrapper.style.position = "fixed";
    wrapper.style.top = "0px";
    wrapper.style.left = Math.round(rect.left) + "px";
    cloneStackCounter += 1;
    wrapper.style.zIndex = String(10 + cloneStackCounter);

    return wrapper;
}


// --------------------------
// INITIALIZE
// --------------------------
document.addEventListener("DOMContentLoaded", () => {
    renderPosts();

function getCurrentPageFromURL() {
    const path = window.location.pathname; // e.g., /page/2
    const match = path.match(/\/page\/(\d+)/);
    if (match) return parseInt(match[1], 10);
    return 1;
}

function updateURLPage(page) {
    history.pushState(null, "", `/page/${page}`);
}

// At the top of your script
currentPage = getCurrentPageFromURL();

// Update renderPagination
function renderPagination() {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = i;
        a.className = i === currentPage ? "current" : "";
        a.onclick = e => {
            e.preventDefault();
            currentPage = i;
            window.scrollTo(0, 0);
            updateURLPage(i);
            renderPosts();
        };
        pagination.appendChild(a);
    }
}
